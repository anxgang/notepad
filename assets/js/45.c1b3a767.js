(window.webpackJsonp=window.webpackJsonp||[]).push([[45],{522:function(s,t,a){"use strict";a.r(t);var n=a(23),e=Object(n.a)({},(function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h1",{attrs:{id:"rails-ubuntu-deploy"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#rails-ubuntu-deploy"}},[s._v("#")]),s._v(" Rails Ubuntu Deploy")]),s._v(" "),a("blockquote",[a("p",[s._v("Ubuntu 20.04 建立 Rails Production 環境")])]),s._v(" "),a("h2",{attrs:{id:"零、主機及設定值"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#零、主機及設定值"}},[s._v("#")]),s._v(" 零、主機及設定值")]),s._v(" "),a("h3",{attrs:{id:"主機資訊"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#主機資訊"}},[s._v("#")]),s._v(" 主機資訊")]),s._v(" "),a("ul",[a("li",[s._v("Linode\n"),a("ul",[a("li",[s._v("Ubuntu 20.04 LTS")]),s._v(" "),a("li",[s._v("1 CPU")]),s._v(" "),a("li",[s._v("50GB Storage")]),s._v(" "),a("li",[s._v("2GB RAM")]),s._v(" "),a("li",[s._v("Tokyo 2, JP")])])])]),s._v(" "),a("h3",{attrs:{id:"範例"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#範例"}},[s._v("#")]),s._v(" 範例")]),s._v(" "),a("ul",[a("li",[s._v("Server IP = 111.111.111.111")]),s._v(" "),a("li",[s._v("Root Password: firstapp123")]),s._v(" "),a("li",[s._v("Ruby = 2.７.1")]),s._v(" "),a("li",[s._v("ProjectName = firstApp")])]),s._v(" "),a("h2",{attrs:{id:"一、設定"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#一、設定"}},[s._v("#")]),s._v(" 一、設定")]),s._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ssh")]),s._v(" root@111.111.111.111\nadduser deploy\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# enter password: ex. deploy123")]),s._v("\nadduser deploy "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exit")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# or ctrl+d")]),s._v("\nssh-copy-id deploy@111.111.111.111\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 會提示輸入密碼")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ssh")]),s._v(" deploy@111.111.111.111\n")])])]),a("h2",{attrs:{id:"二、安裝"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#二、安裝"}},[s._v("#")]),s._v(" 二、安裝")]),s._v(" "),a("p",[s._v("請確保使用 deploy 登入")]),s._v(" "),a("h3",{attrs:{id:"安裝相關套件"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#安裝相關套件"}},[s._v("#")]),s._v(" 安裝相關套件")]),s._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Set Timezone & Language")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" timedatectl set-timezone Asia/Taipei\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" locale-gen zh_TW zh_TW.UTF-8\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Adding Node.js repository")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" -sL https://deb.nodesource.com/setup_12.x "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" -E "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("bash")]),s._v(" -\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Adding Yarn repository")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" -sS https://dl.yarnpkg.com/debian/pubkey.gpg "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" apt-key "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("add")]),s._v(" -\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"deb https://dl.yarnpkg.com/debian/ stable main"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("tee")]),s._v(" /etc/apt/sources.list.d/yarn.list\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Refresh our packages list with the new repositories")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("apt")]),s._v(" update\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Install our dependencies for compiiling Ruby along with Node.js and Yarn")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("apt")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" -y git-core "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" zlib1g-dev build-essential libssl-dev libreadline-dev libyaml-dev libsqlite3-dev sqlite3 libxml2-dev libxslt1-dev libcurl4-openssl-dev software-properties-common libffi-dev dirmngr gnupg gnupg2 apt-transport-https ca-certificates nodejs "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("yarn")]),s._v("\n")])])]),a("h3",{attrs:{id:"安裝-rvm、ruby-及-bundler"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#安裝-rvm、ruby-及-bundler"}},[s._v("#")]),s._v(" 安裝 rvm、ruby 及 bundler")]),s._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[s._v("gpg2 --recv-keys 409B6B1796C275462A1703113804BB82D39DC0E3 7D2BAF1CF37B13E2069D6956105BD0E739499BDB\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("curl -sSL https://get.rvm.io "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("bash")]),s._v(" -s stable\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("source")]),s._v(" /home/deploy/.rvm/scripts/rvm\nrvm "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2.7")]),s._v(".1\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# rvm list 檢查")]),s._v("\ngem "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" bundler\n")])])]),a("h2",{attrs:{id:"三、檢查"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#三、檢查"}},[s._v("#")]),s._v(" 三、檢查")]),s._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("date")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\nruby -v  "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\nbundle -v  \n")])])]),a("h2",{attrs:{id:"四、可選項目"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#四、可選項目"}},[s._v("#")]),s._v(" 四、可選項目")]),s._v(" "),a("h3",{attrs:{id:"_1-nginx"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-nginx"}},[s._v("#")]),s._v(" 1. nginx")]),s._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("apt")]),s._v(" -y "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" nginx\n")])])]),a("h3",{attrs:{id:"_2-redis-server"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-redis-server"}},[s._v("#")]),s._v(" 2. redis server")]),s._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" add-apt-repository -y ppa:chris-lea/redis-server\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("apt")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" -y redis-server redis-tools\n")])])]),a("h3",{attrs:{id:"_3-postgresql"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-postgresql"}},[s._v("#")]),s._v(" 3. postgresql")]),s._v(" "),a("ol",[a("li",[s._v("安裝 postgresql")])]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("sudo apt-get -y install postgresql postgresql-contrib libpq-dev\n")])])]),a("ol",{attrs:{start:"2"}},[a("li",[s._v("postgresql 建立專案 db")])]),s._v(" "),a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"custom-block-title"},[s._v("提示")]),s._v(" "),a("p",[s._v("需要替換『firstApp』")])]),s._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("su")]),s._v(" - postgres\ncreateuser --pwprompt deploy\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 範例設定密碼： deploy321")]),s._v("\ncreatedb -O deploy firstApp\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exit")]),s._v("\n")])])]),a("h2",{attrs:{id:"五、-client-端部署準備"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#五、-client-端部署準備"}},[s._v("#")]),s._v(" 五、 Client 端部署準備")]),s._v(" "),a("h3",{attrs:{id:"_1-安裝-capstrano-相關-gem"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-安裝-capstrano-相關-gem"}},[s._v("#")]),s._v(" 1. 安裝 Capstrano 相關 gem")]),s._v(" "),a("div",{staticClass:"language-ruby extra-class"},[a("pre",{pre:!0,attrs:{class:"language-ruby"}},[a("code",[s._v("group "),a("span",{pre:!0,attrs:{class:"token symbol"}},[s._v(":development")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("do")]),s._v("\n  gem "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"capistrano"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("require")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("false")]),s._v("\n  gem "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'capistrano-rvm'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("require")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("false")]),s._v("\n  gem "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'capistrano-rails'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("require")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("false")]),s._v("\n  gem "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'capistrano-bundler'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("require")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("false")]),s._v("\n  gem "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'capistrano3-puma'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("require")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("false")]),s._v("\n  gem "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'capistrano-rails-console'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("require")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("false")]),s._v("\n  gem "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'capistrano-sidekiq'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("require")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("false")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("end")]),s._v("\n")])])]),a("h3",{attrs:{id:"_2-設定-capfile"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-設定-capfile"}},[s._v("#")]),s._v(" 2. 設定 Capfile")]),s._v(" "),a("p",[s._v("於 require 區塊加入")]),s._v(" "),a("div",{staticClass:"language-ruby extra-class"},[a("pre",{pre:!0,attrs:{class:"language-ruby"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("require")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'capistrano/rails'")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("require")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'capistrano/rvm'")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("require")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'capistrano/bundler'")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("require")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'capistrano/rails/assets'")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("require")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'capistrano/rails/migrations'")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("require")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'capistrano/rails/console'")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("require")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'capistrano/puma'")]),s._v("\ninstall_plugin "),a("span",{pre:!0,attrs:{class:"token constant"}},[s._v("Capistrano")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token constant"}},[s._v("Puma")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("require")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'capistrano/sidekiq'")]),s._v("\n")])])]),a("h3",{attrs:{id:"_3-設定-config-deploy-rb"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-設定-config-deploy-rb"}},[s._v("#")]),s._v(" 3. 設定 config/deploy.rb")]),s._v(" "),a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"custom-block-title"},[s._v("提示")]),s._v(" "),a("p",[s._v("需要替換『firstApp』和『git@github.com:anxgang/first_app.git』")])]),s._v(" "),a("div",{staticClass:"language-ruby extra-class"},[a("pre",{pre:!0,attrs:{class:"language-ruby"}},[a("code",[s._v("lock "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"~> 3.14.1"')]),s._v("\n\nset "),a("span",{pre:!0,attrs:{class:"token symbol"}},[s._v(":application")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"firstApp"')]),s._v("\nset "),a("span",{pre:!0,attrs:{class:"token symbol"}},[s._v(":repo_url")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"git@github.com:anxgang/first_app.git"')]),s._v("\n\nset "),a("span",{pre:!0,attrs:{class:"token symbol"}},[s._v(":user")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'deploy'")]),s._v("\nset "),a("span",{pre:!0,attrs:{class:"token symbol"}},[s._v(":rails_env")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"production"')]),s._v("\n\nset "),a("span",{pre:!0,attrs:{class:"token symbol"}},[s._v(":deploy_to")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/home/'),a("span",{pre:!0,attrs:{class:"token interpolation"}},[a("span",{pre:!0,attrs:{class:"token delimiter tag"}},[s._v("#{")]),s._v("fetch"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token symbol"}},[s._v(":user")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token delimiter tag"}},[s._v("}")])]),s._v("/"),a("span",{pre:!0,attrs:{class:"token interpolation"}},[a("span",{pre:!0,attrs:{class:"token delimiter tag"}},[s._v("#{")]),s._v("fetch"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token symbol"}},[s._v(":application")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token delimiter tag"}},[s._v("}")])]),s._v('"')]),s._v("\n\nappend "),a("span",{pre:!0,attrs:{class:"token symbol"}},[s._v(":linked_files")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"config/master.key"')]),s._v("\nappend "),a("span",{pre:!0,attrs:{class:"token symbol"}},[s._v(":linked_dirs")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"log"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"tmp/pids"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"tmp/cache"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"tmp/sockets"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"public/system"')]),s._v("\n\nnamespace "),a("span",{pre:!0,attrs:{class:"token symbol"}},[s._v(":deploy")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("do")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 覆蓋原本的 puma 指令")]),s._v("\n  desc "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'Restart application'")]),s._v("\n    task "),a("span",{pre:!0,attrs:{class:"token symbol"}},[s._v(":restart")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("do")]),s._v("\n      on roles"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token symbol"}},[s._v(":app")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token symbol"}},[s._v(":sequence")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" wait"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("do")]),s._v("\n      invoke "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'puma:restart'")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("end")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("end")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 上傳 master.key ")]),s._v("\n  namespace "),a("span",{pre:!0,attrs:{class:"token symbol"}},[s._v(":check")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("do")]),s._v("\n    before "),a("span",{pre:!0,attrs:{class:"token symbol"}},[s._v(":linked_files")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token symbol"}},[s._v(":set_master_key")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("do")]),s._v("\n      on roles"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token symbol"}},[s._v(":app")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token symbol"}},[s._v(":sequence")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" wait"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("do")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("unless")]),s._v(" test"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"[ -f '),a("span",{pre:!0,attrs:{class:"token interpolation"}},[a("span",{pre:!0,attrs:{class:"token delimiter tag"}},[s._v("#{")]),s._v("shared_path"),a("span",{pre:!0,attrs:{class:"token delimiter tag"}},[s._v("}")])]),s._v('/config/master.key ]"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n          upload"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'config/master.key'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"'),a("span",{pre:!0,attrs:{class:"token interpolation"}},[a("span",{pre:!0,attrs:{class:"token delimiter tag"}},[s._v("#{")]),s._v("shared_path"),a("span",{pre:!0,attrs:{class:"token delimiter tag"}},[s._v("}")])]),s._v('/config/master.key"')]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("end")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("end")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("end")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("end")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("end")]),s._v("\n\nnamespace "),a("span",{pre:!0,attrs:{class:"token symbol"}},[s._v(":nginx")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("do")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 建立軟連結 (僅首次需使用)")]),s._v("\n  desc "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'Setup symlink to nginx'")]),s._v("\n  task "),a("span",{pre:!0,attrs:{class:"token symbol"}},[s._v(":config")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("do")]),s._v("\n    on roles"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token symbol"}},[s._v(":app")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token symbol"}},[s._v(":sequence")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" wait"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("do")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("unless")]),s._v(" test"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"[ -f /etc/nginx/sites-enabled/'),a("span",{pre:!0,attrs:{class:"token interpolation"}},[a("span",{pre:!0,attrs:{class:"token delimiter tag"}},[s._v("#{")]),s._v("fetch"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token symbol"}},[s._v(":application")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token delimiter tag"}},[s._v("}")])]),s._v(' ]"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        execute "),a("span",{pre:!0,attrs:{class:"token symbol"}},[s._v(":sudo")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token symbol"}},[s._v(":ln")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'-nfs'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" \n          "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/home/'),a("span",{pre:!0,attrs:{class:"token interpolation"}},[a("span",{pre:!0,attrs:{class:"token delimiter tag"}},[s._v("#{")]),s._v("fetch"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token symbol"}},[s._v(":user")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token delimiter tag"}},[s._v("}")])]),s._v("/"),a("span",{pre:!0,attrs:{class:"token interpolation"}},[a("span",{pre:!0,attrs:{class:"token delimiter tag"}},[s._v("#{")]),s._v("fetch"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token symbol"}},[s._v(":application")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token delimiter tag"}},[s._v("}")])]),s._v('/current/config/nginx.conf"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" \n          "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/etc/nginx/sites-enabled/'),a("span",{pre:!0,attrs:{class:"token interpolation"}},[a("span",{pre:!0,attrs:{class:"token delimiter tag"}},[s._v("#{")]),s._v("fetch"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token symbol"}},[s._v(":application")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token delimiter tag"}},[s._v("}")])]),s._v('"')]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("end")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("end")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("end")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Nginx 相關指令")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token symbol"}},[s._v(":start")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token symbol"}},[s._v(":stop")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token symbol"}},[s._v(":restart")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token symbol"}},[s._v(":reload")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token symbol"}},[s._v(":status")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("each")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("do")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("nginx_action"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("\n    desc "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Nginx '),a("span",{pre:!0,attrs:{class:"token interpolation"}},[a("span",{pre:!0,attrs:{class:"token delimiter tag"}},[s._v("#{")]),s._v("nginx_action"),a("span",{pre:!0,attrs:{class:"token delimiter tag"}},[s._v("}")])]),s._v('"')]),s._v("\n    task nginx_action "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("do")]),s._v("\n      on roles"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token symbol"}},[s._v(":app")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("do")]),s._v("\n        execute "),a("span",{pre:!0,attrs:{class:"token symbol"}},[s._v(":sudo")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token symbol"}},[s._v(":service")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token symbol"}},[s._v(":nginx")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" nginx_action\n      "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("end")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("end")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("end")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("end")]),s._v("\n")])])]),a("h3",{attrs:{id:"_4-設定-config-deploy-produciton-rb"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-設定-config-deploy-produciton-rb"}},[s._v("#")]),s._v(" 4. 設定 config/deploy/produciton.rb")]),s._v(" "),a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"custom-block-title"},[s._v("提示")]),s._v(" "),a("p",[s._v("需替換 主機IP 『111.111.111.111』")])]),s._v(" "),a("div",{staticClass:"language-ruby extra-class"},[a("pre",{pre:!0,attrs:{class:"language-ruby"}},[a("code",[s._v("role "),a("span",{pre:!0,attrs:{class:"token symbol"}},[s._v(":app")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("%w(deploy@111.111.111.111)")]),s._v("\nrole "),a("span",{pre:!0,attrs:{class:"token symbol"}},[s._v(":web")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("%w(deploy@111.111.111.111)")]),s._v("\nrole "),a("span",{pre:!0,attrs:{class:"token symbol"}},[s._v(":db")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("%w(deploy@111.111.111.111)")]),s._v("\n")])])]),a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"custom-block-title"},[s._v("提示")]),s._v(" "),a("p",[s._v("如需要也可設定 staging.rb")])]),s._v(" "),a("h3",{attrs:{id:"修改-db-設定"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#修改-db-設定"}},[s._v("#")]),s._v(" 修改 db 設定")]),s._v(" "),a("p",[s._v("config/database.yml")]),s._v(" "),a("div",{staticClass:"language-yml extra-class"},[a("pre",{pre:!0,attrs:{class:"language-yml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("production")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("<<")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token important"}},[s._v("*default")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("adapter")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" postgresql\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("encoding")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" unicode\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("database")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" firstApp\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("pool")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("username")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" <%= Rails.application.credentials.pg"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("username"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" %"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("password")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" <%= Rails.application.credentials.pg"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("password"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" %"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")]),s._v("\n")])])]),a("h3",{attrs:{id:"調整-credentials"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#調整-credentials"}},[s._v("#")]),s._v(" 調整 credentials")]),s._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("EDITOR")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'code --wait'")]),s._v(" rails credentials:edit\n")])])]),a("p",[s._v("加入")]),s._v(" "),a("div",{staticClass:"language-yml extra-class"},[a("pre",{pre:!0,attrs:{class:"language-yml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("pg")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("username")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'deploy'")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("password")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'deploy321'")]),s._v("\n")])])]),a("h3",{attrs:{id:"加入-config-nginx-conf"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#加入-config-nginx-conf"}},[s._v("#")]),s._v(" 加入 config/nginx.conf")]),s._v(" "),a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"custom-block-title"},[s._v("TIP")]),s._v(" "),a("p",[s._v("請替換 『 firstapp.anxgang.com 』")])]),s._v(" "),a("div",{staticClass:"language-py extra-class"},[a("pre",{pre:!0,attrs:{class:"language-py"}},[a("code",[s._v("upstream firstApp "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("  \n  server unix"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("//")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("home"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("deploy"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("firstApp"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("shared"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("tmp"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("sockets"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("puma"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("sock"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# server firstApp:3000; # optional")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" \nserver "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("  \n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# define your domain  ")]),s._v("\n  server_name firstapp"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("anxgang"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("com"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# define the public application root  ")]),s._v("\n  root   "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("home"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("deploy"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("firstApp"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("current"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("public"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("  \n  index  index"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("html"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# define where Nginx should write its logs  ")]),s._v("\n  access_log "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("home"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("deploy"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("firstApp"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("current"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("log"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("nginx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("access"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("log"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("  \n  error_log "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("home"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("deploy"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("firstApp"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("current"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("log"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("nginx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("error"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("log"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    \n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# deny requests for files that should never be accessed  ")]),s._v("\n  location "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("~")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("\\"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("    \n      deny "),a("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("all")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("  \n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n  location "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("~")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("^")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v("\\"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("rb"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("log"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("$ "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("    \n      deny "),a("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("all")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("  \n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("  \n\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# serve static (compiled) assets directly if they exist (for rails production)  ")]),s._v("\n  location "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("~")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("^")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("assets"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("images"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("javascripts"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("stylesheets"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("packs"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("system"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("    \n    try_files $uri @rails"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("     \n    access_log off"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("    \n    gzip_static on"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" \n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# to serve pre-gzipped version     ")]),s._v("\n    expires "),a("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("max")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("    \n    add_header Cache"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("Control public"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("     \n    \n    add_header Last"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("Modified "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('""')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("    \n    add_header ETag "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('""')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("    \n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("break")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("  \n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" \n  \n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# send non-static file requests to the app server  ")]),s._v("\n  location "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("    \n    try_files $uri @rails"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("  \n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("   \n  location @rails "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("    \n    proxy_set_header  X"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("Real"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("IP  $remote_addr"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("    \n    proxy_set_header  X"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("Forwarded"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("For $proxy_add_x_forwarded_for"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("         \n    proxy_set_header Host $http_host"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("    \n    proxy_redirect off"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("    \n    proxy_pass http"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("//")]),s._v("firstApp"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("  \n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n  location "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("cable "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    proxy_pass http"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("//")]),s._v("firstApp"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    proxy_http_version "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1.1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    proxy_set_header Upgrade $http_upgrade"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    proxy_set_header Connection "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"upgrade"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n  error_page "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("500")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("502")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("503")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("504")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("500.")]),s._v("html"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  client_max_body_size 10M"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  keepalive_timeout "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])])]),a("h2",{attrs:{id:"六、開始部署"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#六、開始部署"}},[s._v("#")]),s._v(" 六、開始部署")]),s._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("git")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("add")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(".")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("git")]),s._v(" commit -m "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"commit message"')]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("git")]),s._v(" push origin master\n")])])]),a("h3",{attrs:{id:"首次部署"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#首次部署"}},[s._v("#")]),s._v(" 首次部署")]),s._v(" "),a("p",[s._v("需要 deploy:check ，會建立一些資料夾、軟連結，並上傳 master.key")]),s._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[s._v("cap production deploy:check\ncap production deploy\n")])])]),a("h3",{attrs:{id:"後續部署"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#後續部署"}},[s._v("#")]),s._v(" 後續部署")]),s._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[s._v("cap production deploy\n")])])]),a("h3",{attrs:{id:"為專案建立-symlink"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#為專案建立-symlink"}},[s._v("#")]),s._v(" 為專案建立 symlink")]),s._v(" "),a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"custom-block-title"},[s._v("提示")]),s._v(" "),a("p",[s._v("需要替換『 firstApp 』")])]),s._v(" "),a("p",[s._v("登入 server")]),s._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ssh")]),s._v(" deploy@111.111.111.111\n")])])]),a("p",[s._v("設定軟連結")]),s._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("rm")]),s._v(" /etc/nginx/sites-enabled/default\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ln")]),s._v(" -nfs "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/home/deploy/firstApp/current/config/nginx.conf"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/etc/nginx/sites-enabled/firstApp"')]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ls -lah /etc/nginx/sites-enabled/firstApp 確認一下")]),s._v("\n")])])]),a("p",[s._v("重啟伺服器")]),s._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("service")]),s._v(" nginx restart\n")])])]),a("p",[s._v("這時候可以連到 http://111.111.111.111 看看網頁是否正常"),a("br"),s._v("\n若有問題 可至 firstApp/current/log 下面去查看相關的 log")]),s._v(" "),a("h2",{attrs:{id:"七、後續"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#七、後續"}},[s._v("#")]),s._v(" 七、後續")]),s._v(" "),a("h3",{attrs:{id:"domain"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#domain"}},[s._v("#")]),s._v(" Domain")]),s._v(" "),a("ul",[a("li",[s._v("freenom - 有免費 domain 可註冊使用，付費的也很便宜")])]),s._v(" "),a("h3",{attrs:{id:"https"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#https"}},[s._v("#")]),s._v(" Https")]),s._v(" "),a("p",[s._v("以下擇一")]),s._v(" "),a("ul",[a("li",[s._v("cloudflare - 可直接設定 https，nginx 不用調整")]),s._v(" "),a("li",[s._v("certbot - 可快速設定 Let’s Encrypt 提供的 https 驗證服務，插入設定值到 nginx.conf 並產生定時重新驗證的排程")])])])}),[],!1,null,null,null);t.default=e.exports}}]);
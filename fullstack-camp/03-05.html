<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>5-加入使用者功能 | notepad</title>
    <meta name="generator" content="VuePress 1.5.2">
    <link rel="icon" href="/notepad/favicon.ico">
    <meta name="description" content="一個小小筆記本">
    <link rel="preload" href="/notepad/assets/css/0.styles.e4f7a2f2.css" as="style"><link rel="preload" href="/notepad/assets/js/app.abc900cd.js" as="script"><link rel="preload" href="/notepad/assets/js/2.de767da7.js" as="script"><link rel="preload" href="/notepad/assets/js/17.40bc1197.js" as="script"><link rel="prefetch" href="/notepad/assets/js/10.b2c06949.js"><link rel="prefetch" href="/notepad/assets/js/11.c9e2691f.js"><link rel="prefetch" href="/notepad/assets/js/12.63f79b42.js"><link rel="prefetch" href="/notepad/assets/js/13.f7af4e8d.js"><link rel="prefetch" href="/notepad/assets/js/14.31b24aa9.js"><link rel="prefetch" href="/notepad/assets/js/15.ee275869.js"><link rel="prefetch" href="/notepad/assets/js/16.baece4fe.js"><link rel="prefetch" href="/notepad/assets/js/18.1c6f3d85.js"><link rel="prefetch" href="/notepad/assets/js/19.ffd304a8.js"><link rel="prefetch" href="/notepad/assets/js/20.d16e10f7.js"><link rel="prefetch" href="/notepad/assets/js/21.9bf663a6.js"><link rel="prefetch" href="/notepad/assets/js/22.a96f91d1.js"><link rel="prefetch" href="/notepad/assets/js/23.d82ddc41.js"><link rel="prefetch" href="/notepad/assets/js/24.cbdef2f9.js"><link rel="prefetch" href="/notepad/assets/js/25.236bf007.js"><link rel="prefetch" href="/notepad/assets/js/26.42754cbe.js"><link rel="prefetch" href="/notepad/assets/js/27.69e3f6e3.js"><link rel="prefetch" href="/notepad/assets/js/28.917a0ffd.js"><link rel="prefetch" href="/notepad/assets/js/29.a5dfebe9.js"><link rel="prefetch" href="/notepad/assets/js/3.b28a5640.js"><link rel="prefetch" href="/notepad/assets/js/30.f3254c32.js"><link rel="prefetch" href="/notepad/assets/js/31.3671faaa.js"><link rel="prefetch" href="/notepad/assets/js/32.156d06d3.js"><link rel="prefetch" href="/notepad/assets/js/33.82cadb70.js"><link rel="prefetch" href="/notepad/assets/js/34.c1b3533d.js"><link rel="prefetch" href="/notepad/assets/js/35.14bbedca.js"><link rel="prefetch" href="/notepad/assets/js/36.1d786d21.js"><link rel="prefetch" href="/notepad/assets/js/37.ae49daca.js"><link rel="prefetch" href="/notepad/assets/js/38.14c91a38.js"><link rel="prefetch" href="/notepad/assets/js/39.949464aa.js"><link rel="prefetch" href="/notepad/assets/js/4.f36ccaf5.js"><link rel="prefetch" href="/notepad/assets/js/40.ac472316.js"><link rel="prefetch" href="/notepad/assets/js/41.2aa5b49e.js"><link rel="prefetch" href="/notepad/assets/js/42.082133ed.js"><link rel="prefetch" href="/notepad/assets/js/43.2c454234.js"><link rel="prefetch" href="/notepad/assets/js/44.3e01dbc8.js"><link rel="prefetch" href="/notepad/assets/js/45.c1b3a767.js"><link rel="prefetch" href="/notepad/assets/js/46.1b528671.js"><link rel="prefetch" href="/notepad/assets/js/47.fa275e25.js"><link rel="prefetch" href="/notepad/assets/js/48.82431801.js"><link rel="prefetch" href="/notepad/assets/js/49.26b95970.js"><link rel="prefetch" href="/notepad/assets/js/5.d8810cd1.js"><link rel="prefetch" href="/notepad/assets/js/50.080a8b89.js"><link rel="prefetch" href="/notepad/assets/js/51.eb4ba65f.js"><link rel="prefetch" href="/notepad/assets/js/52.9b2ec4b6.js"><link rel="prefetch" href="/notepad/assets/js/53.b9291662.js"><link rel="prefetch" href="/notepad/assets/js/54.adf368fd.js"><link rel="prefetch" href="/notepad/assets/js/55.7b43fc99.js"><link rel="prefetch" href="/notepad/assets/js/56.40f4e551.js"><link rel="prefetch" href="/notepad/assets/js/57.283e1e67.js"><link rel="prefetch" href="/notepad/assets/js/58.60dd1afe.js"><link rel="prefetch" href="/notepad/assets/js/59.f1434f61.js"><link rel="prefetch" href="/notepad/assets/js/6.466d8455.js"><link rel="prefetch" href="/notepad/assets/js/7.f05a3669.js"><link rel="prefetch" href="/notepad/assets/js/8.5d885b12.js"><link rel="prefetch" href="/notepad/assets/js/9.5e35ba9f.js">
    <link rel="stylesheet" href="/notepad/assets/css/0.styles.e4f7a2f2.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/notepad/" class="home-link router-link-active"><!----> <span class="site-name">notepad</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/notepad/git/" class="nav-link">
  Git
</a></div><div class="nav-item"><a href="/notepad/ruby/" class="nav-link">
  Ruby
</a></div><div class="nav-item"><a href="/notepad/rails/" class="nav-link">
  Rails
</a></div><div class="nav-item"><a href="/notepad/javascript/" class="nav-link">
  Javascript
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="More" class="dropdown-title"><span class="title">More</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/notepad/roadmap/" class="nav-link">
  開發者路線指引
</a></li><li class="dropdown-item"><!----> <a href="/notepad/basic-for-web-developers/" class="nav-link">
  網頁基礎(HTML&amp;CSS)
</a></li><li class="dropdown-item"><!----> <a href="/notepad/fullstack-camp/" class="nav-link router-link-active">
  全棧營(Rails101)
</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/notepad/git/" class="nav-link">
  Git
</a></div><div class="nav-item"><a href="/notepad/ruby/" class="nav-link">
  Ruby
</a></div><div class="nav-item"><a href="/notepad/rails/" class="nav-link">
  Rails
</a></div><div class="nav-item"><a href="/notepad/javascript/" class="nav-link">
  Javascript
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="More" class="dropdown-title"><span class="title">More</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/notepad/roadmap/" class="nav-link">
  開發者路線指引
</a></li><li class="dropdown-item"><!----> <a href="/notepad/basic-for-web-developers/" class="nav-link">
  網頁基礎(HTML&amp;CSS)
</a></li><li class="dropdown-item"><!----> <a href="/notepad/fullstack-camp/" class="nav-link router-link-active">
  全棧營(Rails101)
</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>第零課、入學手冊</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>第一課、環境建置</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>第二課、初級練習</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>第三課、Rails101</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/notepad/fullstack-camp/03-01.html" class="sidebar-link">1-教材介紹</a></li><li><a href="/notepad/fullstack-camp/03-02.html" class="sidebar-link">2-開始吧!</a></li><li><a href="/notepad/fullstack-camp/03-03.html" class="sidebar-link">3-建立一個討論群組</a></li><li><a href="/notepad/fullstack-camp/03-04.html" class="sidebar-link">4-手動實作討論群的“新增”“修改”“刪除”功能</a></li><li><a href="/notepad/fullstack-camp/03-05.html" aria-current="page" class="active sidebar-link">5-加入使用者功能</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/notepad/fullstack-camp/03-05.html#_5-1-本章目標" class="sidebar-link">5-1 本章目標</a></li><li class="sidebar-sub-header"><a href="/notepad/fullstack-camp/03-05.html#_5-2-安裝-devise-gem" class="sidebar-link">5-2 安裝 devise gem</a></li><li class="sidebar-sub-header"><a href="/notepad/fullstack-camp/03-05.html#_5-3-讓這個網站有實際-登錄-、-退出-的功能" class="sidebar-link">5-3 讓這個網站有實際“登錄”、“退出”的功能</a></li><li class="sidebar-sub-header"><a href="/notepad/fullstack-camp/03-05.html#_5-4-讓-群組-與-使用者-產生關聯" class="sidebar-link">5-4 讓“群組”與“使用者”產生關聯</a></li><li class="sidebar-sub-header"><a href="/notepad/fullstack-camp/03-05.html#_5-5-只有群組的-創始者-可以-編輯-刪除-群組資訊" class="sidebar-link">5-5 只有群組的“創始者”可以“編輯”“刪除”群組資訊</a></li></ul></li><li><a href="/notepad/fullstack-camp/03-06.html" class="sidebar-link">6-在討論群裡面“發表文章”</a></li><li><a href="/notepad/fullstack-camp/03-07.html" class="sidebar-link">7-使用者應該要“加入社團”才能發表文章</a></li><li><a href="/notepad/fullstack-camp/03-08.html" class="sidebar-link">8-使用者可以在“自己的後台”看過曾經發表的文章、以及創立的社團</a></li><li><a href="/notepad/fullstack-camp/03-09.html" class="sidebar-link">9-修飾細節，使用 Helper 與 Partial</a></li><li><a href="/notepad/fullstack-camp/03-10.html" class="sidebar-link">10-上傳到 github 與 heroku</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="_5-加入使用者功能"><a href="#_5-加入使用者功能" class="header-anchor">#</a> 5-加入使用者功能</h1> <blockquote><p>預計學習時間: 2小時以內</p></blockquote> <h2 id="_5-1-本章目標"><a href="#_5-1-本章目標" class="header-anchor">#</a> 5-1 本章目標</h2> <h3 id="本章目標"><a href="#本章目標" class="header-anchor">#</a> 本章目標</h3> <ul><li>安裝“會員系統”（使用 devise）</li> <li>在 navbar 安裝登錄/退出按鈕</li> <li>只有登錄了的使用者，才可以建立群組</li> <li>只有群組的建立者，才可以 編輯 / 刪除群組</li></ul> <p><img src="/notepad/assets/img/maxresdefault.e54cdc22.jpg" alt=""></p> <p><img src="/notepad/assets/img/maxresdefault.e54cdc22.jpg" alt=""></p> <h2 id="_5-2-安裝-devise-gem"><a href="#_5-2-安裝-devise-gem" class="header-anchor">#</a> 5-2 安裝 devise gem</h2> <h3 id="目標"><a href="#目標" class="header-anchor">#</a> 目標</h3> <ul><li>做會員系統似乎很困難？讓我告訴你，在 Rails 內一點都不會！</li> <li>利用 devise 實作會員系統</li></ul> <h3 id="步驟"><a href="#步驟" class="header-anchor">#</a> 步驟</h3> <h4 id="step-0-git-checkout-b-ch04"><a href="#step-0-git-checkout-b-ch04" class="header-anchor">#</a> Step 0. git checkout -b ch04</h4> <p>因為我們現在要實作第四章的內容，新增一個 branch 把實作內容集中在 ch04 是比較合理的。將來回顧就可以比較清楚 在 ch04 我們做了哪一些練習。</p> <p><code>git checkout -b ch04</code></p> <h4 id="step-1-安裝登錄系統"><a href="#step-1-安裝登錄系統" class="header-anchor">#</a> Step 1: 安裝登錄系統</h4> <p>Devise 是一個 Rails 內熱門的 gem，專門用來快速實作“登錄系統”。在這一章我們會用 devise 實作登錄功能。</p> <p>Gemfile 新增一行 gem 'devise'</p> <div class="language-ruby extra-class"><pre class="language-ruby"><code>gem <span class="token string">'devise'</span>
</code></pre></div><p><img src="/notepad/assets/img/maxresdefault.e54cdc22.jpg" alt=""></p> <p>然後執行</p> <p><code>bundle install</code></p> <h4 id="step-2-產生會員系統的必要文件"><a href="#step-2-產生會員系統的必要文件" class="header-anchor">#</a> Step 2 : 產生會員系統的必要文件</h4> <p>執行</p> <p><code>rails g devise:install</code><br> <code>rails g devise user</code><br> <code>rake db:migrate</code></p> <p><img src="/notepad/assets/img/maxresdefault.e54cdc22.jpg" alt=""></p> <p><img src="/notepad/assets/img/maxresdefault.e54cdc22.jpg" alt=""></p> <p>然後重開 rails server</p> <h4 id="step-3-在-groups-controller-限制-新增討論群-必須先登錄"><a href="#step-3-在-groups-controller-限制-新增討論群-必須先登錄" class="header-anchor">#</a> Step 3: 在 groups_controller 限制 “新增討論群”必須先登錄</h4> <p>在 app/controllers/groups_controller.rb 加入一行 before_action :authenticate_user! , only: [:new]</p> <div class="language-ruby extra-class"><pre class="language-ruby"><code><span class="token comment"># app/controllers/groups_controller.rb</span>
<span class="token keyword">class</span> <span class="token class-name">GroupsController</span> <span class="token operator">&lt;</span> <span class="token constant">ApplicationController</span>
  before_action <span class="token symbol">:authenticate_user!</span> <span class="token punctuation">,</span> only<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token symbol">:new</span><span class="token punctuation">]</span>
  <span class="token comment">#...略</span>
<span class="token keyword">end</span>
</code></pre></div><p>然後這時候當你要訪問 http://localhost:3000/groups/new 時，就會出現“登錄畫面”阻擋。可以註冊一個賬戶試試效果。</p> <p><img src="/notepad/assets/img/maxresdefault.e54cdc22.jpg" alt=""></p> <h4 id="step-4-git-存檔"><a href="#step-4-git-存檔" class="header-anchor">#</a> Step 4: git 存檔</h4> <p><code>git add .</code><br> <code>git commit -m &quot;install devise&quot;</code></p> <h3 id="本節常見問題"><a href="#本節常見問題" class="header-anchor">#</a> 本節常見問題</h3> <div class="custom-block tip"><p class="custom-block-title">devise 幫我們做了什麼？</p> <p>在這一階段的細節，你不太需要知道他是怎麼運作？（事實上也很複雜）</p> <ul><li>你只要知道 <code>before_action :authenticate_user!</code> 可以幫你做出“限制使用者必須登入”的功能。</li></ul></div> <div class="custom-block tip"><p class="custom-block-title">before_action 又是什麼呢？</p> <p>before_action 後面加的往往是一個 controller 內的 method，在這裡 :authenticate_user! 是 devise 提供的內建功能。</p> <ul><li><code>before_action :authenticate_user! , only: [:new]</code>，表示“只有 new 需要登入”</li> <li><code>before_action :authenticate_user!</code> 後面不加任何東西，表示這個 controller 下的所有 action 都要登入。</li> <li>你可以把 before_action 想像成“先過我這一關”的“攔截器”</li></ul></div> <h2 id="_5-3-讓這個網站有實際-登錄-、-退出-的功能"><a href="#_5-3-讓這個網站有實際-登錄-、-退出-的功能" class="header-anchor">#</a> 5-3 讓這個網站有實際“登錄”、“退出”的功能</h2> <h3 id="目標-2"><a href="#目標-2" class="header-anchor">#</a> 目標</h3> <ul><li>讓右上角的“登錄”可以實際有：“登錄” / “退出的效果”</li></ul> <h3 id="步驟-2"><a href="#步驟-2" class="header-anchor">#</a> 步驟</h3> <h4 id="step-1-修改-app-views-common-navbar-html-erb"><a href="#step-1-修改-app-views-common-navbar-html-erb" class="header-anchor">#</a> Step 1: 修改 app/views/common/_navbar.html.erb</h4> <div class="language-erb extra-class"><pre class="language-erb"><code><span class="token comment">&lt;!-- app/views/common/_navbar.html.erb --&gt;</span>
- <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span>
-   <span class="token erb language-erb"><span class="token delimiter punctuation">&lt;%=</span> link_to<span class="token punctuation">(</span><span class="token string">&quot;登錄&quot;</span><span class="token punctuation">,</span> <span class="token string">'#'</span><span class="token punctuation">)</span> <span class="token delimiter punctuation">%&gt;</span></span>
- <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
+ <span class="token erb language-erb"><span class="token delimiter punctuation">&lt;%</span> <span class="token keyword">if</span> <span class="token operator">!</span>current_user <span class="token delimiter punctuation">%&gt;</span></span>
+   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span><span class="token erb language-erb"><span class="token delimiter punctuation">&lt;%=</span> link_to<span class="token punctuation">(</span><span class="token string">&quot;註冊&quot;</span><span class="token punctuation">,</span> new_user_registration_path<span class="token punctuation">)</span> <span class="token delimiter punctuation">%&gt;</span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
+   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span><span class="token erb language-erb"><span class="token delimiter punctuation">&lt;%=</span> link_to<span class="token punctuation">(</span><span class="token string">&quot;登錄&quot;</span><span class="token punctuation">,</span> new_user_session_path<span class="token punctuation">)</span> <span class="token delimiter punctuation">%&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
+ <span class="token erb language-erb"><span class="token delimiter punctuation">&lt;%</span> <span class="token keyword">else</span> <span class="token delimiter punctuation">%&gt;</span></span>
+   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>dropdown<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
+     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>#<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>dropdown-toggle<span class="token punctuation">&quot;</span></span> <span class="token attr-name">data-toggle</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>dropdown<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
+         Hi!, <span class="token erb language-erb"><span class="token delimiter punctuation">&lt;%=</span> current_user<span class="token punctuation">.</span>email <span class="token delimiter punctuation">%&gt;</span></span>
+         <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>b</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>caret<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>b</span><span class="token punctuation">&gt;</span></span>
+     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
+     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>dropdown-menu<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
+         <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span> <span class="token erb language-erb"><span class="token delimiter punctuation">&lt;%=</span> link_to<span class="token punctuation">(</span><span class="token string">&quot;退出&quot;</span><span class="token punctuation">,</span> destroy_user_session_path<span class="token punctuation">,</span> method<span class="token punctuation">:</span> <span class="token symbol">:delete</span><span class="token punctuation">)</span> <span class="token delimiter punctuation">%&gt;</span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
+     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">&gt;</span></span>
+   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
+ <span class="token erb language-erb"><span class="token delimiter punctuation">&lt;%</span> <span class="token keyword">end</span> <span class="token delimiter punctuation">%&gt;</span></span>
</code></pre></div><p><strong>（+號代表新增的意思，複製貼上的時候請刪掉它，-號代表刪除的意思）</strong></p> <h4 id="step-2-修改-app-assets-javascripts-application-js"><a href="#step-2-修改-app-assets-javascripts-application-js" class="header-anchor">#</a> Step 2: 修改 app/assets/javascripts/application.js</h4> <p>加入 //= require bootstrap/dropdown</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//= require bootstrap/alert</span>
<span class="token operator">+</span> <span class="token comment">//= require bootstrap/dropdown</span>
</code></pre></div><p><strong>（+號代表新增的意思，複製貼上的時候請刪掉它）</strong></p> <p>成果應該會是這樣的效果。</p> <p><img src="/notepad/assets/img/maxresdefault.e54cdc22.jpg" alt=""></p> <p><img src="/notepad/assets/img/maxresdefault.e54cdc22.jpg" alt=""></p> <h4 id="step-3-git-儲存"><a href="#step-3-git-儲存" class="header-anchor">#</a> Step 3: git 儲存</h4> <p><code>git add .</code><br> <code>git commit -m &quot;user can login/logout/signup&quot;</code></p> <h3 id="本節常見問題-2"><a href="#本節常見問題-2" class="header-anchor">#</a> 本節常見問題</h3> <div class="custom-block tip"><p class="custom-block-title">current_user 是什麼？</p> <p>current_user 是 Devise 提供的“正在登入的當前用戶”，你可以在 controller 或 view 裡面使用它。</p></div> <div class="custom-block tip"><p class="custom-block-title">!current_user 又是什麼</p> <p>! 表示不等於。!current_user 表示“現在沒有登入的用戶”（不在登入的狀態）</p></div> <h2 id="_5-4-讓-群組-與-使用者-產生關聯"><a href="#_5-4-讓-群組-與-使用者-產生關聯" class="header-anchor">#</a> 5-4 讓“群組”與“使用者”產生關聯</h2> <h3 id="目標-3"><a href="#目標-3" class="header-anchor">#</a> 目標</h3> <ul><li>我們要讓“群組”記錄是“被誰開的”。</li> <li>並且在看板一覽表顯示出來“開設者的名稱”</li></ul> <h3 id="步驟-3"><a href="#步驟-3" class="header-anchor">#</a> 步驟</h3> <h4 id="step-1-新增-user-id-到-group-的-table-裡"><a href="#step-1-新增-user-id-到-group-的-table-裡" class="header-anchor">#</a> Step 1: 新增 user_id 到 group 的 table 裡</h4> <p>執行</p> <p><code>rails g migration add_user_id_to_group</code></p> <p><img src="/notepad/assets/img/maxresdefault.e54cdc22.jpg" alt=""></p> <p>然後打開剛剛新增的 migration 檔，修改讓它長得像這樣</p> <div class="language-ruby extra-class"><pre class="language-ruby"><code><span class="token comment"># db/migrate/一串數字_add_user_id_to_group</span>
<span class="token keyword">class</span> <span class="token class-name">AddUserIdToGroup</span> <span class="token operator">&lt;</span> <span class="token constant">ActiveRecord</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">Migration</span><span class="token punctuation">[</span><span class="token number">6.0</span><span class="token punctuation">]</span>
  <span class="token keyword">def</span> <span class="token method-definition"><span class="token function">change</span></span>
    add_column <span class="token symbol">:groups</span><span class="token punctuation">,</span> <span class="token symbol">:user_id</span><span class="token punctuation">,</span> <span class="token symbol">:integer</span>
  <span class="token keyword">end</span>
<span class="token keyword">end</span>
</code></pre></div><p>然後，執行</p> <p><code>rake db:migrate</code></p> <h4 id="step-2-連結-user-與-group-的雙向關係"><a href="#step-2-連結-user-與-group-的雙向關係" class="header-anchor">#</a> Step 2: 連結 user 與 group 的雙向關係</h4> <p>修改 app/models/user.rb 加入 has_many :groups</p> <div class="language-ruby extra-class"><pre class="language-ruby"><code><span class="token comment"># app/models/user.rb</span>
classUser <span class="token operator">&lt;</span> <span class="token constant">ApplicationRecord</span>
  <span class="token comment"># Include default devise modules. Others available are:</span>
  <span class="token comment"># :confirmable, :lockable, :timeoutable and :omniauthable</span>
  devise <span class="token symbol">:database_authenticatable</span><span class="token punctuation">,</span> <span class="token symbol">:registerable</span><span class="token punctuation">,</span>
          <span class="token symbol">:recoverable</span><span class="token punctuation">,</span> <span class="token symbol">:rememberable</span><span class="token punctuation">,</span> <span class="token symbol">:trackable</span><span class="token punctuation">,</span> <span class="token symbol">:validatable</span>

  has_many <span class="token symbol">:groups</span>
<span class="token keyword">end</span>
</code></pre></div><p>修改 app/models/group.rb 加入 belongs_to :user</p> <div class="language-ruby extra-class"><pre class="language-ruby"><code><span class="token comment"># app/models/group.rb</span>
<span class="token keyword">class</span> <span class="token class-name">Group</span> <span class="token operator">&lt;</span> <span class="token constant">ApplicationRecord</span>
  belongs_to <span class="token symbol">:user</span>
  validates <span class="token symbol">:title</span><span class="token punctuation">,</span> presence<span class="token punctuation">:</span> <span class="token boolean">true</span>
<span class="token keyword">end</span>
</code></pre></div><h3 id="step-3-在新增看板時，記錄誰是群組的建立者"><a href="#step-3-在新增看板時，記錄誰是群組的建立者" class="header-anchor">#</a> Step 3: 在新增看板時，記錄誰是群組的建立者</h3> <p>修改 app/controllers/groups_controller.rb，在需要“登入驗證”的 action 列表再加入 create。</p> <div class="language-ruby extra-class"><pre class="language-ruby"><code><span class="token comment"># app/controllers/groups_controller.rb</span>
classGroupsController <span class="token operator">&lt;</span> <span class="token constant">ApplicationController</span>
  before_action <span class="token symbol">:authenticate_user!</span> <span class="token punctuation">,</span> only<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token symbol">:new</span><span class="token punctuation">,</span> <span class="token symbol">:create</span><span class="token punctuation">]</span>
  <span class="token comment">#...略</span>
<span class="token keyword">end</span>
</code></pre></div><p>修改 app/controllers/groups_controller.rb，在 create 中，多加入一行 @group.user = current_user。</p> <p>變成以下內容：</p> <div class="language-ruby extra-class"><pre class="language-ruby"><code><span class="token comment"># app/controllers/groups_controller.rb</span>
<span class="token keyword">def</span> <span class="token method-definition"><span class="token function">create</span></span> 
  <span class="token variable">@group</span> <span class="token operator">=</span> <span class="token constant">Group</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span>group_params<span class="token punctuation">)</span>
  <span class="token variable">@group</span><span class="token punctuation">.</span>user <span class="token operator">=</span> current_user

  <span class="token keyword">if</span> <span class="token variable">@group</span><span class="token punctuation">.</span>save
    redirect_to groups_path
  <span class="token keyword">else</span>
    render <span class="token symbol">:new</span>
  <span class="token keyword">end</span>
<span class="token keyword">end</span>
</code></pre></div><h4 id="step-4-git-儲存"><a href="#step-4-git-儲存" class="header-anchor">#</a> Step 4 : git 儲存</h4> <p><code>git add .</code><br> <code>git commit -m &quot;add user_id to group&quot;</code></p> <h4 id="step-5-修改-group-列表，將-user-的名字列上去"><a href="#step-5-修改-group-列表，將-user-的名字列上去" class="header-anchor">#</a> Step 5 : 修改 group 列表，將 user 的名字列上去</h4> <p>修改 app/views/groups/index.html.erb 然後把 Creator 的訊息加進去。（程式碼如下）</p> <p><img src="/notepad/assets/img/maxresdefault.e54cdc22.jpg" alt=""></p> <div class="language-erb extra-class"><pre class="language-erb"><code><span class="token comment">&lt;!-- app/views/groups/index.html.erb --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>col-md-12<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>group<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token erb language-erb"><span class="token delimiter punctuation">&lt;%=</span> link_to<span class="token punctuation">(</span><span class="token string">&quot;New group&quot;</span><span class="token punctuation">,</span> new_group_path<span class="token punctuation">,</span> <span class="token keyword">class</span><span class="token punctuation">:</span> <span class="token string">&quot;btn btn-primary pull-right&quot;</span><span class="token punctuation">)</span> <span class="token delimiter punctuation">%&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>table</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>table table-hover<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>thead</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>tr</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span><span class="token punctuation">&gt;</span></span>#<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span><span class="token punctuation">&gt;</span></span>Title<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span><span class="token punctuation">&gt;</span></span>Description<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">&gt;</span></span>
+       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span><span class="token punctuation">&gt;</span></span>Creator <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>tr</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>thead</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>tbody</span><span class="token punctuation">&gt;</span></span>
      <span class="token erb language-erb"><span class="token delimiter punctuation">&lt;%</span> <span class="token variable">@groups</span><span class="token punctuation">.</span><span class="token keyword">each</span> <span class="token keyword">do</span> <span class="token operator">|</span>group<span class="token operator">|</span> <span class="token delimiter punctuation">%&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>tr</span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span><span class="token punctuation">&gt;</span></span>#<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span><span class="token punctuation">&gt;</span></span><span class="token erb language-erb"><span class="token delimiter punctuation">&lt;%=</span> link_to<span class="token punctuation">(</span>group<span class="token punctuation">.</span>title<span class="token punctuation">,</span> group_path<span class="token punctuation">(</span>group<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token delimiter punctuation">%&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span><span class="token punctuation">&gt;</span></span><span class="token erb language-erb"><span class="token delimiter punctuation">&lt;%=</span> group<span class="token punctuation">.</span>description <span class="token delimiter punctuation">%&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">&gt;</span></span>
+         <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span><span class="token punctuation">&gt;</span></span> <span class="token erb language-erb"><span class="token delimiter punctuation">&lt;%=</span> group<span class="token punctuation">.</span>user<span class="token punctuation">.</span>email <span class="token delimiter punctuation">%&gt;</span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span><span class="token punctuation">&gt;</span></span>
              <span class="token erb language-erb"><span class="token delimiter punctuation">&lt;%=</span> link_to<span class="token punctuation">(</span><span class="token string">&quot;Edit&quot;</span><span class="token punctuation">,</span> edit_group_path<span class="token punctuation">(</span>group<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">class</span><span class="token punctuation">:</span> <span class="token string">&quot;btn btn-sm btn-default&quot;</span><span class="token punctuation">)</span><span class="token delimiter punctuation">%&gt;</span></span>
              <span class="token erb language-erb"><span class="token delimiter punctuation">&lt;%=</span> link_to<span class="token punctuation">(</span><span class="token string">&quot;Delete&quot;</span><span class="token punctuation">,</span> group_path<span class="token punctuation">(</span>group<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token keyword">class</span><span class="token punctuation">:</span> <span class="token string">&quot;btn btn-sm btn-default&quot;</span><span class="token punctuation">,</span>
                          method<span class="token punctuation">:</span> <span class="token symbol">:delete</span><span class="token punctuation">,</span> data<span class="token punctuation">:</span> <span class="token punctuation">{</span> confirm<span class="token punctuation">:</span> <span class="token string">&quot;Are you sure?&quot;</span> <span class="token punctuation">}</span> <span class="token punctuation">)</span><span class="token delimiter punctuation">%&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>tr</span><span class="token punctuation">&gt;</span></span>
      <span class="token erb language-erb"><span class="token delimiter punctuation">&lt;%</span> <span class="token keyword">end</span> <span class="token delimiter punctuation">%&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>tbody</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>table</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>做完之後，打開 http://localhost:3000/ 會發現，首頁怎麼爆炸了。</p> <p><img src="/notepad/assets/img/maxresdefault.e54cdc22.jpg" alt=""></p> <p>別擔心，這是因為我們之前創造的“群組”都是“無主”的。只要把這些“無主”的群組，通通刪掉就行了。既然我們也進不去首頁刪群組了，我們就從 console 刪吧。</p> <h4 id="step-6-刪除所有-無主-的群組"><a href="#step-6-刪除所有-無主-的群組" class="header-anchor">#</a> Step 6: 刪除所有“無主”的群組</h4> <p>執行</p> <p><code>rails console</code></p> <p>然後輸入</p> <p><code>Group.delete_all</code></p> <p><img src="/notepad/assets/img/maxresdefault.e54cdc22.jpg" alt=""></p> <p>輸入 <code>exit</code> 退出 console</p> <p>然後再打開 http://localhost:3000/ 就正常了。</p> <p><img src="/notepad/assets/img/maxresdefault.e54cdc22.jpg" alt=""></p> <p>這時候我們再新增一筆數據，就會顯示 creator 的訊息了。</p> <p><img src="/notepad/assets/img/maxresdefault.e54cdc22.jpg" alt=""></p> <h4 id="step-7-git-存檔"><a href="#step-7-git-存檔" class="header-anchor">#</a> Step 7 : git 存檔</h4> <p><code>git add .</code><br> <code>git commit -m &quot;show group's creator info &quot;</code></p> <h3 id="本節常見問題-3"><a href="#本節常見問題-3" class="header-anchor">#</a> 本節常見問題</h3> <div class="custom-block tip"><p class="custom-block-title">has_many 與 belongs_to 是什麼意思？</p> <p>has_many 擁有很多
belongs_to 屬於
就是這麼直觀！記得你一定要幫他們加上關聯！</p></div> <h2 id="_5-5-只有群組的-創始者-可以-編輯-刪除-群組資訊"><a href="#_5-5-只有群組的-創始者-可以-編輯-刪除-群組資訊" class="header-anchor">#</a> 5-5 只有群組的“創始者”可以“編輯”“刪除”群組資訊</h2> <h3 id="目標-4"><a href="#目標-4" class="header-anchor">#</a> 目標</h3> <ul><li>路人不應該可以看到“編輯”“刪除”按鈕</li> <li>只有群組的“創始者”可以實際執行“編輯”“刪除”群組資訊</li></ul> <h3 id="步驟-4"><a href="#步驟-4" class="header-anchor">#</a> 步驟</h3> <h4 id="step-1-路人不應該可以看到-編輯-刪除-按鈕"><a href="#step-1-路人不應該可以看到-編輯-刪除-按鈕" class="header-anchor">#</a> Step 1: 路人不應該可以看到“編輯”“刪除”按鈕</h4> <p>讓我們登出系統，在這裡我們察覺一個嚴重的問題：明明是路人，怎麼能看到“編輯”“刪除”按鈕的資訊呢？</p> <p><img src="/notepad/assets/img/maxresdefault.e54cdc22.jpg" alt=""></p> <p>所以在這裡我們要把“編輯”“刪除”這兩個按鈕藏起來，限定</p> <ul><li>只有登入模式下</li> <li>而且還必須是群組“創始者”</li></ul> <p>才能看得到這個兩個按鈕，否則路人是看不到的。</p> <p>修改 app/views/groups/index.html.erb</p> <p>加入   &lt;% if current_user &amp;&amp; current_user == group.user %&gt; 的判斷式</p> <div class="language-ruby extra-class"><pre class="language-ruby"><code><span class="token comment"># app/views/groups/index.html.erb</span>
<span class="token operator">&lt;</span>td<span class="token operator">&gt;</span>
<span class="token operator">+</span> <span class="token operator">&lt;</span><span class="token operator">%</span> <span class="token keyword">if</span> current_user <span class="token operator">&amp;&amp;</span> current_user <span class="token operator">==</span> group<span class="token punctuation">.</span>user <span class="token string">%&gt;
  &lt;%= link_to(&quot;Edit&quot;, edit_group_path(group), class: &quot;btn btn-sm btn-default&quot;)%&gt;</span>
  <span class="token operator">&lt;</span><span class="token operator">%</span><span class="token operator">=</span> link_to<span class="token punctuation">(</span><span class="token string">&quot;Delete&quot;</span><span class="token punctuation">,</span> group_path<span class="token punctuation">(</span>group<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token keyword">class</span><span class="token punctuation">:</span> <span class="token string">&quot;btn btn-sm btn-default&quot;</span><span class="token punctuation">,</span>
                method<span class="token punctuation">:</span> <span class="token symbol">:delete</span><span class="token punctuation">,</span> data<span class="token punctuation">:</span> <span class="token punctuation">{</span> confirm<span class="token punctuation">:</span> <span class="token string">&quot;Are you sure?&quot;</span> <span class="token punctuation">}</span> <span class="token punctuation">)</span><span class="token string">%&gt;
+ &lt;% end %&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>td<span class="token operator">&gt;</span>
</code></pre></div><p><img src="/notepad/assets/img/maxresdefault.e54cdc22.jpg" alt=""></p> <p>重新刷新首頁，路人現在就看不到按鈕了。</p> <p><img src="/notepad/assets/img/maxresdefault.e54cdc22.jpg" alt=""></p> <h4 id="step-2-git-存檔"><a href="#step-2-git-存檔" class="header-anchor">#</a> Step 2: git 存檔</h4> <p><code>git add .</code><br> <code>git commit -m &quot;people can't see edit button unless he is group owner&quot;</code></p> <h4 id="step-3-路人不應該也可以-直接輸入網址-去存取-edit-update-destroy-action"><a href="#step-3-路人不應該也可以-直接輸入網址-去存取-edit-update-destroy-action" class="header-anchor">#</a> Step 3: 路人不應該也可以“直接輸入網址”去存取 edit / update / destroy action</h4> <p>除了將按鈕對路人隱藏外，我們還要考慮到一個情形，假設這個路人是知道 Rails 規則的，那麼他可能輸入</p> <div class="language- extra-class"><pre class="language-text"><code>http://localhost:3000/groups/某筆數據的ID/edit
</code></pre></div><p>網址，就直接可以編輯數據。</p> <p>我們也要在 controller 做權限判斷，濾掉這種人。</p> <p>首先，我們先限定 edit / update / destroy 這三個操作動作，必須要是“登入”的使用者才能存取。</p> <p>修改 app/controllers/groups_controller.rb 在 before_action :authenticate_user!  列表中，加入 :edit, :update, :destroy</p> <div class="language-ruby extra-class"><pre class="language-ruby"><code><span class="token comment"># app/controllers/groups_controller.rb</span>
<span class="token keyword">class</span> <span class="token class-name">GroupsController</span> <span class="token operator">&lt;</span> <span class="token constant">ApplicationController</span>
  before_action <span class="token symbol">:authenticate_user!</span> <span class="token punctuation">,</span> only<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token symbol">:new</span><span class="token punctuation">,</span> <span class="token symbol">:create</span><span class="token punctuation">,</span> <span class="token symbol">:edit</span><span class="token punctuation">,</span> <span class="token symbol">:update</span><span class="token punctuation">,</span> <span class="token symbol">:destroy</span><span class="token punctuation">]</span>
  <span class="token comment">#...略</span>
<span class="token keyword">end</span>
</code></pre></div><p>這樣“沒登錄”的路人，就進不來了。但這只是第一步。</p> <h4 id="step-4-必須要是-group-擁有人，才能進入-edit，否則會被重導至首頁，並顯示錯誤訊息。"><a href="#step-4-必須要是-group-擁有人，才能進入-edit，否則會被重導至首頁，並顯示錯誤訊息。" class="header-anchor">#</a> Step 4: 必須要是 group 擁有人，才能進入 edit，否則會被重導至首頁，並顯示錯誤訊息。</h4> <p>修改 app/controllers/groups_controller.rb 加入權限，如果不是“創始者”去存取，會顯示沒有權限的錯誤訊息。</p> <div class="language-ruby extra-class"><pre class="language-ruby"><code><span class="token comment"># app/controllers/groups_controller.rb</span>
<span class="token keyword">def</span> <span class="token method-definition"><span class="token function">edit</span></span>
  <span class="token variable">@group</span> <span class="token operator">=</span> <span class="token constant">Group</span><span class="token punctuation">.</span>find<span class="token punctuation">(</span>params<span class="token punctuation">[</span><span class="token symbol">:id</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

  <span class="token keyword">if</span> current_user <span class="token operator">!=</span> <span class="token variable">@group</span><span class="token punctuation">.</span>user
    redirect_to root_path<span class="token punctuation">,</span> alert<span class="token punctuation">:</span> <span class="token string">&quot;You have no permission.&quot;</span>
  <span class="token keyword">end</span>
<span class="token keyword">end</span>
</code></pre></div><p>這樣當其他人，試圖輸入</p> <div class="language- extra-class"><pre class="language-text"><code>http://localhost:3000/groups/某筆數據的ID/edit
</code></pre></div><p>這樣的網址，想要編輯數據，就會被擋住。</p> <p><img src="/notepad/assets/img/maxresdefault.e54cdc22.jpg" alt=""></p> <h4 id="step-5-依樣畫葫蘆的把-權限檢查-的程式碼，套用到-update-destroy-上"><a href="#step-5-依樣畫葫蘆的把-權限檢查-的程式碼，套用到-update-destroy-上" class="header-anchor">#</a> Step 5: 依樣畫葫蘆的把“權限檢查”的程式碼，套用到 update / destroy 上</h4> <p>修改 app/controllers/groups_controller.rb 中的 update 與 destroy 部分。</p> <div class="language-ruby extra-class"><pre class="language-ruby"><code><span class="token comment"># app/controllers/groups_controller.rb</span>
<span class="token keyword">def</span> <span class="token method-definition"><span class="token function">update</span></span>
  <span class="token variable">@group</span> <span class="token operator">=</span><span class="token constant">Group</span><span class="token punctuation">.</span>find<span class="token punctuation">(</span>params<span class="token punctuation">[</span><span class="token symbol">:id</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

  <span class="token keyword">if</span> current_user <span class="token operator">!=</span> <span class="token variable">@group</span><span class="token punctuation">.</span>user
    redirect_to root_path<span class="token punctuation">,</span> alert<span class="token punctuation">:</span> <span class="token string">&quot;You have no permission.&quot;</span>
  <span class="token keyword">end</span>

  <span class="token keyword">if</span> <span class="token variable">@group</span><span class="token punctuation">.</span>update<span class="token punctuation">(</span>group_params<span class="token punctuation">)</span>
    redirect_to groups_path<span class="token punctuation">,</span> notice<span class="token punctuation">:</span> <span class="token string">&quot;Update Success&quot;</span>
  <span class="token keyword">else</span>
    render <span class="token symbol">:edit</span>
  <span class="token keyword">end</span>
<span class="token keyword">end</span>

<span class="token keyword">def</span> <span class="token method-definition"><span class="token function">destroy</span></span>
  <span class="token variable">@group</span> <span class="token operator">=</span> <span class="token constant">Group</span><span class="token punctuation">.</span>find<span class="token punctuation">(</span>params<span class="token punctuation">[</span><span class="token symbol">:id</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

  <span class="token keyword">if</span> current_user <span class="token operator">!=</span> <span class="token variable">@group</span><span class="token punctuation">.</span>user
    redirect_to root_path<span class="token punctuation">,</span> alert<span class="token punctuation">:</span> <span class="token string">&quot;You have no permission.&quot;</span>
  <span class="token keyword">end</span>

  <span class="token variable">@group</span><span class="token punctuation">.</span>destroy
  redirect_to groups_path<span class="token punctuation">,</span> alert<span class="token punctuation">:</span> <span class="token string">&quot;Group deleted&quot;</span>
<span class="token keyword">end</span>
</code></pre></div><h4 id="step-6-git-存檔"><a href="#step-6-git-存檔" class="header-anchor">#</a> Step 6: git 存檔</h4> <p><code>git add .</code><br> <code>git commit -m &quot;check owner permission when access edit/update/destroy&quot;</code></p> <h4 id="step-7-製作-find-group-and-check-permission"><a href="#step-7-製作-find-group-and-check-permission" class="header-anchor">#</a> Step 7: 製作 find_group_and_check_permission</h4> <p>我們發現 edit、update、destroy 這三個 action 都有一樣的程式碼，看起來有點冗。</p> <div class="language-ruby extra-class"><pre class="language-ruby"><code><span class="token variable">@group</span> <span class="token operator">=</span> <span class="token constant">Group</span><span class="token punctuation">.</span>find<span class="token punctuation">(</span>params<span class="token punctuation">[</span><span class="token symbol">:id</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> current_user <span class="token operator">!=</span> <span class="token variable">@group</span><span class="token punctuation">.</span>user
  redirect_to root_path<span class="token punctuation">,</span> alert<span class="token punctuation">:</span> <span class="token string">&quot;You have no permission.&quot;</span>
<span class="token keyword">end</span>
</code></pre></div><p>其實我們可以透過把它包裝成一個函式的方式 find_group_and_check_permission 去省略這段冗餘程式碼。</p> <p>打開 app/controllers/groups_controller.rb  在 private 下，新增一個 find_group_and_check_permission</p> <div class="language-ruby extra-class"><pre class="language-ruby"><code><span class="token comment"># app/controllers/groups_controller.rb</span>
<span class="token comment"># ...略</span>
<span class="token keyword">private</span>
  <span class="token keyword">def</span> <span class="token method-definition"><span class="token function">find_group_and_check_permission</span></span>
    <span class="token variable">@group</span> <span class="token operator">=</span> <span class="token constant">Group</span><span class="token punctuation">.</span>find<span class="token punctuation">(</span>params<span class="token punctuation">[</span><span class="token symbol">:id</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

    <span class="token keyword">if</span> current_user <span class="token operator">!=</span> <span class="token variable">@group</span><span class="token punctuation">.</span>user
      redirect_to root_path<span class="token punctuation">,</span> alert<span class="token punctuation">:</span> <span class="token string">&quot;You have no permission.&quot;</span>
    <span class="token keyword">end</span>
  <span class="token keyword">end</span>

  <span class="token keyword">def</span> <span class="token method-definition"><span class="token function">group_params</span></span>
    params<span class="token punctuation">.</span><span class="token keyword">require</span><span class="token punctuation">(</span><span class="token symbol">:group</span><span class="token punctuation">)</span><span class="token punctuation">.</span>permit<span class="token punctuation">(</span><span class="token symbol">:title</span><span class="token punctuation">,</span> <span class="token symbol">:description</span><span class="token punctuation">)</span>
  <span class="token keyword">end</span>

<span class="token keyword">end</span>
</code></pre></div><p>再修正 edit</p> <div class="language-ruby extra-class"><pre class="language-ruby"><code><span class="token comment"># app/controllers/groups_controller.rb</span>
<span class="token keyword">def</span> <span class="token method-definition"><span class="token function">edit</span></span>
  find_group_and_check_permission
<span class="token keyword">end</span>
</code></pre></div><p>修正 update</p> <div class="language-ruby extra-class"><pre class="language-ruby"><code><span class="token comment"># app/controllers/groups_controller.rb</span>
<span class="token keyword">def</span> <span class="token method-definition"><span class="token function">update</span></span>
  find_group_and_check_permission

  <span class="token keyword">if</span> <span class="token variable">@group</span><span class="token punctuation">.</span>update<span class="token punctuation">(</span>group_params<span class="token punctuation">)</span>
    redirect_to groups_path<span class="token punctuation">,</span> notice<span class="token punctuation">:</span> <span class="token string">&quot;Update Success&quot;</span>
  <span class="token keyword">else</span>
    render <span class="token symbol">:edit</span>
  <span class="token keyword">end</span>
<span class="token keyword">end</span>
</code></pre></div><p>修正 destroy</p> <div class="language-ruby extra-class"><pre class="language-ruby"><code><span class="token comment"># app/controllers/groups_controller.rb</span>
<span class="token keyword">def</span> <span class="token method-definition"><span class="token function">destroy</span></span>
  find_group_and_check_permission

  <span class="token variable">@group</span><span class="token punctuation">.</span>destroy
  redirect_to groups_path<span class="token punctuation">,</span> alert<span class="token punctuation">:</span> <span class="token string">&quot;Group deleted&quot;</span>
<span class="token keyword">end</span>
</code></pre></div><h4 id="step-8-把-find-group-and-check-permission-掛到-before-action"><a href="#step-8-把-find-group-and-check-permission-掛到-before-action" class="header-anchor">#</a> Step 8: 把 find_group_and_check_permission 掛到 before_action</h4> <p>開發到這裡你會發現一件事，find_group_and_check_permission 其實都是在這三個 action 的最前面開頭執行的，所以你甚至可以這樣寫，把 find_group_and_check_permission 掛到 before_action</p> <div class="language-ruby extra-class"><pre class="language-ruby"><code><span class="token comment"># app/controllers/groups_controller.rb</span>
<span class="token keyword">class</span> <span class="token class-name">GroupsController</span> <span class="token operator">&lt;</span> <span class="token constant">ApplicationController</span>
  before_action <span class="token symbol">:authenticate_user!</span> <span class="token punctuation">,</span> only<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token symbol">:new</span><span class="token punctuation">,</span> <span class="token symbol">:create</span><span class="token punctuation">,</span> <span class="token symbol">:edit</span><span class="token punctuation">,</span> <span class="token symbol">:update</span><span class="token punctuation">,</span> <span class="token symbol">:destroy</span><span class="token punctuation">]</span>
  before_action <span class="token symbol">:find_group_and_check_permission</span><span class="token punctuation">,</span> only<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token symbol">:edit</span><span class="token punctuation">,</span> <span class="token symbol">:update</span><span class="token punctuation">,</span> <span class="token symbol">:destroy</span><span class="token punctuation">]</span>
  <span class="token comment"># ...略</span>
<span class="token keyword">end</span>
</code></pre></div><p>然後再把 edit update destroy 裡的 find_group_and_check_permission 砍掉。變成這樣：</p> <div class="language-ruby extra-class"><pre class="language-ruby"><code><span class="token comment"># app/controllers/groups_controller.rb</span>
<span class="token keyword">def</span> <span class="token method-definition"><span class="token function">edit</span></span>
<span class="token keyword">end</span>

<span class="token keyword">def</span> <span class="token method-definition"><span class="token function">update</span></span>
  <span class="token keyword">if</span> <span class="token variable">@group</span><span class="token punctuation">.</span>update<span class="token punctuation">(</span>group_params<span class="token punctuation">)</span>
    redirect_to groups_path<span class="token punctuation">,</span> notice<span class="token punctuation">:</span> <span class="token string">&quot;Update Success&quot;</span>
  <span class="token keyword">else</span>
    render <span class="token symbol">:edit</span>
  <span class="token keyword">end</span>
<span class="token keyword">end</span>

<span class="token keyword">def</span> <span class="token method-definition"><span class="token function">destroy</span></span>
  <span class="token variable">@group</span><span class="token punctuation">.</span>destroy
  redirect_to groups_path<span class="token punctuation">,</span> alert<span class="token punctuation">:</span> <span class="token string">&quot;Group deleted&quot;</span>
<span class="token keyword">end</span>
</code></pre></div><h4 id="step-9-git-存檔"><a href="#step-9-git-存檔" class="header-anchor">#</a> Step 9: git 存檔</h4> <p><code>git add .</code><br> <code>git commit -m &quot;use before_action to find_group_and_check_permission&quot;</code></p> <h4 id="step-10-修掉-show-裡面的-edit-按鈕"><a href="#step-10-修掉-show-裡面的-edit-按鈕" class="header-anchor">#</a> Step 10 : 修掉 show 裡面的 Edit 按鈕</h4> <p>做到這裡，我們還發現一個地方，我們漏了改，那就是 show.html.erb 上面，還有一個 Edit 按鈕我們還沒有拔掉。</p> <p><img src="/notepad/assets/img/maxresdefault.e54cdc22.jpg" alt=""></p> <p>修改 app/views/groups/show.html.erb ，然後加入</p> <p>加入 &lt;% if current_user &amp;&amp; current_user == @group.user %&gt; 的判斷式</p> <p><img src="/notepad/assets/img/maxresdefault.e54cdc22.jpg" alt=""></p> <div class="language-ruby extra-class"><pre class="language-ruby"><code><span class="token comment"># app/views/groups/show.html.erb</span>
<span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;group&quot;</span><span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span><span class="token operator">%</span> <span class="token keyword">if</span> current_user <span class="token operator">&amp;&amp;</span> current_user <span class="token operator">==</span> <span class="token variable">@group</span><span class="token punctuation">.</span>user <span class="token string">%&gt;
    &lt;%= link_to(&quot;Edit&quot;, edit_group_path(@group), class: &quot;btn btn-primary pull-right&quot;)%&gt;</span>
  <span class="token operator">&lt;</span><span class="token operator">%</span> <span class="token keyword">end</span> <span class="token string">%&gt;
&lt;/div&gt;</span>
</code></pre></div><p>如此按鈕就被修掉了。</p> <h4 id="step-11-git-存檔"><a href="#step-11-git-存檔" class="header-anchor">#</a> Step 11: git 存檔</h4> <p><code>git add .</code><br> <code>git commit -m &quot;add permission check on show page&quot;</code></p> <h3 id="本節常見問題-4"><a href="#本節常見問題-4" class="header-anchor">#</a> 本節常見問題</h3> <div class="custom-block tip"><p class="custom-block-title">= 與 == 與 != 他們三者是什麼？</p> <ul><li>= 是指派。@groups = Group.all，把 Group.all 數值 指派給 @groups 的意思。</li> <li>== “等於”</li> <li>!= “不等於”</li></ul></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">最後更新時間:</span> <span class="time">2020-8-10 23:55:52</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/notepad/fullstack-camp/03-04.html" class="prev">
        4-手動實作討論群的“新增”“修改”“刪除”功能
      </a></span> <span class="next"><a href="/notepad/fullstack-camp/03-06.html">
        6-在討論群裡面“發表文章”
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/notepad/assets/js/app.abc900cd.js" defer></script><script src="/notepad/assets/js/2.de767da7.js" defer></script><script src="/notepad/assets/js/17.40bc1197.js" defer></script>
  </body>
</html>
